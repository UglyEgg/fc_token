version: 1

AppDir:
  path: ./AppDir

  app_info:
    id: com.filecxx.fc-token
    name: File Centipede Activation Helper
    icon: fc_token
    version: 0.2.0
    exec: usr/bin/python3.13
    exec_args: "-m fc_token.app $@"

  runtime:
    env:
      PATH: "${APPDIR}/usr/bin:${PATH}"
      PYTHONHOME: "${APPDIR}/usr"
      PYTHONPATH: "${APPDIR}/usr/lib/python3.13/site-packages:${APPDIR}/usr/lib/python3.13"
      SSL_CERT_FILE: "${APPDIR}/usr/lib/python3.13/site-packages/certifi/cacert.pem"
      QT_QPA_PLATFORMTHEME: "qt6ct"

  apt:
    arch: amd64
    sources:
      - sourceline: "deb http://archive.ubuntu.com/ubuntu/ jammy main universe"
      - sourceline: "deb http://archive.ubuntu.com/ubuntu/ jammy-updates main universe"
      - sourceline: "deb http://ppa.launchpad.net/deadsnakes/ppa/ubuntu jammy main"
        key_url: "https://keyserver.ubuntu.com/pks/lookup?op=get&search=0xBA6932366A755776"
    include:
      - python3.13
      - python3.13-venv
      - ca-certificates
      # GUI/runtime libs typically needed by Qt/PyQt wheels on Linux:
      - libgl1
      - libx11-6
      - libxext6
      - libxrender1
      - libxcb1
      - libxkbcommon0
      - libdbus-1-3
      - libglib2.0-0
    exclude:
      - "*-dev"
      - "*-dbg"

  files:
    include:
      - /usr/lib/x86_64-linux-gnu
      - /usr/share/icons
    exclude:
      - /usr/share/doc
      - /usr/share/man
      - /usr/share/locale/*
      - /usr/share/icons/Adwaita

  after_bundle: |
    set -euo pipefail

    # appimage-builder provides TARGET_APPDIR; use it (not $APPDIR).
    APPDIR="$TARGET_APPDIR"
    export PATH="$APPDIR/usr/bin:$PATH"
    export PYTHONHOME="$APPDIR/usr"
    export PYTHONPATH="$APPDIR/usr/lib/python3.13/site-packages:$APPDIR/usr/lib/python3.13"

    echo "[fc-token] Ensure pip is available in bundled python"
    "$APPDIR/usr/bin/python3.13" -m ensurepip --upgrade || true
    "$APPDIR/usr/bin/python3.13" -m pip install --upgrade --no-input pip wheel setuptools

    echo "[fc-token] Install project into AppDir (/usr prefix)"
    cd "$SOURCE_DIR"
    "$APPDIR/usr/bin/python3.13" -m pip install \
      --no-input \
      --upgrade \
      --ignore-installed \
      --prefix=/usr \
      --root="$APPDIR" \
      .

  test:
    smoke:
      image: ubuntu:jammy
      command: "./AppRun --version"
      env:
        QT_QPA_PLATFORM: "offscreen"
    self_test:
      image: ubuntu:jammy
      command: "./AppRun --self-test"
      env:
        QT_QPA_PLATFORM: "offscreen"

AppImage:
  arch: x86_64
  update-information: ""
  # sign-key: null
